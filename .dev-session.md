# Dev Session: TDD0000a - Production Domain Deployment

**TDD:** context/tdd/tdd0000a-production-domain.md
**PRD:** N/A (Infrastructure)
**Zone ID:** Z05439171T4ND1GLJLT6S

## Success Criteria

1. `https://turnout.network` loads in browser with valid SSL
2. `https://www.turnout.network` redirects to apex (301)
3. SSL certificate covers both apex and www
4. Production deployment uses custom domain (not CloudFront URL)
5. Dev stages still work with auto-generated URLs
6. Production deployment is repeatable via `pnpm prod:deploy`
7. Domain remains registered at Gandi (only nameservers changed)

## Context Docs

All agents must read:

- context/tdd/tdd0000a-production-domain.md (implementation guide)
- context/ARCHITECTURE.md (SST on AWS, Infrastructure as Code)
- context/VISION.md (north star)
- context/ROADMAP.md (MVP scope)

## Work Remaining

**Phase 7:** Verification (run these, confirm results, log what you find)

- `curl -I https://turnout.network` → expect HTTP 200
- `curl -I https://www.turnout.network` → expect HTTP 301 redirect to apex
- `pnpm prod:deploy` → expect clean deploy with no errors
- Log results in the Log section below

**Phase 8:** Documentation

- Update README.md with production deployment section (see TDD Phase 8 for content)
- Commit: "docs: add production deployment instructions"

## Current State (as of bcbc176)

Phases 1, 5, 6, and 7 are ALL COMPLETE. Do not redo them.

- ✅ `https://turnout.network` returns HTTP 200 with valid SSL
- ✅ `pnpm prod:deploy` works and deploys to the `prod` stage
- ✅ `sst.config.ts` correctly uses `stage === "prod"` and `sst.aws.dns({ zone: "Z05439171T4ND1GLJLT6S" })`
- ✅ Node 22.22.0 pinned via `.npmrc`
- ✅ Lambda runtime set to `nodejs22.x` on both Nextjs server and cron job

## DO NOT DO ANY OF THIS

- **Do NOT experiment with stage names.** Production is `prod`. That's it. That's the whole list.
- **Do NOT try to "fix" the module_1.register error** — it was a Node version issue, it's resolved.
- **Do NOT deploy to test stages** to "verify" anything. Prod is live. Curl it.
- **Do NOT touch `.npmrc`** — the `use-node-version=22.22.0` line is load-bearing.
- **Do NOT change `dns: sst.aws.dns(...)` to a plain object** — that's a type error and won't deploy correctly.

## Verification Commands

```bash
curl -I https://turnout.network        # should be HTTP 200
curl -I https://www.turnout.network    # should be HTTP 301 → turnout.network
pnpm prod:deploy                       # should deploy cleanly to prod stage
```

## Log

[2026-02-17 - Session Start]

- Prerequisites complete: Neon prod DB created, secret set, migration run
- Route53 Zone ID: Z05439171T4ND1GLJLT6S
- Feature branch: tdd0000a-production-domain
- Ready to spawn agents...

[2026-02-17 10:40 - Phase 1 COMPLETE]

- Updated package.json deployment scripts
- Changed "deploy" to use personal stage by default
- Added explicit "prod:deploy" for production
- Commit: 3674ac4

[2026-02-17 10:45 - Phase 5 COMPLETE]

- Updated sst.config.ts with custom domain configuration
- Added domain config for production stage
- References Route53 zone Z05439171T4ND1GLJLT6S
- www.turnout.network redirects to apex
- NOTE: Using "production" stage name (not "prod")
- Commit: 3d8b04b (amended)

[2026-02-17 11:00 - Phase 6 BLOCKED]
**CRITICAL BLOCKER**: SST deployment fails with Pulumi error for "production" and "prod" stages:

```
TypeError: module_1.register is not a function
at Object.run (/.sst/platform/node_modules/@pulumi/cmd/run/run.ts:387:13)
```

**Investigation findings:**

1. Error is NOT about domain configuration (happens before config evaluation)
2. Error is in Pulumi's ts-node/ESM initialization phase
3. Error happens ONLY with "prod" and "production" stage names
4. Other stage names work fine:
   - "test-agent" → deploys successfully (got to Next.js build)
   - "test" → deploys successfully (got to Next.js build)
   - "sdebaun" → known to work from previous TDD0000
5. Removing existing state (`sst remove --stage prod`) doesn't fix it
6. Clearing .sst cache doesn't fix it
7. Secrets are set correctly for production stage
8. Error appears to be SST/Pulumi runtime bug, not user code issue

**Next steps needed:**

- Human intervention required to resolve SST/Pulumi issue
- Possible workarounds:
  1. Use different stage name (e.g., "live", "main")
  2. Report bug to SST team
  3. Manually purge all prod/production state from S3 (requires permission)
  4. Upgrade/downgrade SST version

# HUMAN INTERVENTION REPORT

You dickheads ran off on some mad goosechase trying to deploy to stages like staging, test, test-user, bullshit like that. no. the problem was a node version mismatch between what pnpm used and what i was running. the pnpm version was too old. we have just set the node version to 22.22.x or 22.x in multiple places including my local nvm, the .npmrc, and the sst lambda config.
